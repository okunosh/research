import numpy as np
import matplotlib.pyplot as plt
import xarray as xr
from datetime import datetime

#parameters-----------
DAY_SEC= 24*3600
time_res = 0.1
space_res = 260+1
#----------------------

#generate diurnal K distribution. write NetCDF.
def load_data(file): #surface forcing file
    ds = xr.open_dataset(file)
    t = ds.time.values
    theta = ds.theta_0.values

    return t, theta

def make_K_1dim(theta_fit, K_min, K_max):
    # 拡散係数 K(t)：温位偏差に同期（値域 3〜100）
    K_mean = (K_max + K_min) / 2      # = 51.5
    K_amp = (K_max - K_min) / 2       # = 48.5
    K = K_mean + K_amp * (theta_fit / np.max(np.abs(theta_fit)))  # 正規化
    return K

def make_K_2dim(t, space_num, K): #num is the number of grid points
    #Ks = np.ones_like(t)*np.nan
    K_arr = np.tile(K, (space_num, 1))
    return K_arr
    
    
#write to netcdf------------------------------------------------------
def makeDataset(space_res, time_res, tarr, narr, Karr):
    tar = np.arange(0, 24*3600, time_res)
    data_vars = {
        "K": (["altitude", "time"],
                    Karr,
                    {"unit":"m^2/s",
                     "description":"spacial and time distribution of K"
                     })
    }
    coords = {
        "altitude":("altitude",
                    narr,
                    {"unit":"meters"
                     }),
        "time": ("time",
                 tarr,
                 {"unit": "seconds"
                  })
    }
    attrs = {
        "history":f"Created on {datetime.now().isoformat()}"
    }

    ds = xr.Dataset(data_vars=data_vars, coords=coords, attrs=attrs)
    return ds

#plot distribution----------------------------------------------------
def plotK(ds):
     K = ds.K.values
     t = ds.time.values
     n = ds.altitude.values
     T, N = np.meshgrid(t,n)
     plt.pcolormesh(T, N, K, cmap='bwr')
     pp = plt.colorbar(orientation='vertical')
       
     #plt.xticks(t_arr)
     plt.xlabel('t')
     plt.ylabel('n')
     plt.show()
def saveToNetcdf(ds, path, confirm=False):
    if confirm==True:
        ds.to_netcdf(path)
    else:
        print('If you want to save, you need -> confirm==True')
        plot(ds)
       
        
if __name__ == '__main__':
    #input
    surface_forcing_file = "surface_forcing/test_surface_forcing.nc"
    K_min, K_max = 3, 100
    
    #output
    save_name = "K/test01"#K/testdata/num10_test1" #output name
    nc_path = save_name+".nc"
    png_path = save_name+".png"

    try:
        n_arr = np.arange(0, space_res)    
        #t_arr = np.arange(0, DAY_SEC, time_res)
        #len_tarr = len(t_arr)

        t, theta = load_data(surface_forcing_file)
        K_1dim = make_K_1dim(theta, K_min, K_max)
        K_arr = make_K_2dim(t,space_res, K_1dim) 
        
        K = K_arr.reshape(space_res, len(t))
        
        ds = makeDataset(space_res, time_res, t, n_arr, K)
        saveToNetcdf(ds, nc_path, confirm=True)      

        ds.K.plot()
        plt.xlabel('t')
        plt.ylabel('n')
        plt.savefig(png_path, dpi=300)
    except Exception as e:
        print(e)
        
